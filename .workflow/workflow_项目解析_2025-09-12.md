# 功能：项目解析（Tauri 2.x × crates/indexer 集成）

## 核心分析
- **需求目标**：前端仅提供“选择项目文件夹”的入口；Tauri 主进程接收根路径并调用 `crates/indexer` 完成遍历与解析，通过事件流向前端报告进度与结果，支持取消。
- **范围（In/Out）**：
  - In：
    - 在 `src-tauri` 暴露命令：`start_indexing(root, options) -> task_id`、`cancel_indexing(task_id)`。
    - 使用事件通道推送：`indexer://progress`、`indexer://done`、`indexer://error`。
    - 桌面端新增左侧菜单入口与页面路由（`/indexer`），提供“选择目录 / 开始解析 / 取消 / 进度展示”。
    - 忽略规则：`.gitignore` + 常见构建输出目录，支持自定义黑名单（UI 勾选）。
  - Out：
    - 前端不读取文件内容、不一次性回传全量路径到前端；不做数据库落盘；不实现多项目并行（先支持单任务 + 取消）。
- **技术选型**：
  - 后端：Tauri 2.x（`tauri = "2"`），Rust 2021；集成 `crates/indexer`；并发遍历基于 `ignore::WalkBuilder`（库已内置）；事件 `app.emit`；任务状态使用 `Arc<Mutex<...>>` 或 `dashmap`。
  - 前端：React + AntD；路由采用 `react-router-dom@^6` 的 `HashRouter`；与 Tauri 交互用 `@tauri-apps/api` 的 `dialog`、`event`、`invoke`。
  - 质量：`cargo check/clippy`、`tsc --noEmit`、eslint/prettier。
- **非功能需求**：
  - 性能：常见仓库（≤50k 文件）扫描阶段内存 ≤ 150MB，UI 不冻结；事件节流 ≥ 50ms 一次。
  - 安全：路径来自用户显式选择；Tauri 2 capabilities 仅开放 `dialog.open` 与事件；Rust 端遵守忽略策略与尺寸上限。
  - 可运维：控制台日志按 task_id 打标；错误集中上报到 `indexer://error`。
- **依赖与前置**：
  - Rust 端在 `apps/desktop/src-tauri/Cargo.toml` 声明 `crates/indexer` 本地依赖；可能新增 `dashmap`。
  - 前端新增依赖：`react-router-dom`、`@tauri-apps/api`（已存在则复用）。
  - 配置：`apps/desktop/src-tauri/capabilities/*` 开放 `dialog` 与 `event`；如需 `fs.scope` 仅限 Rust 端读取，无需前端 `fs` 权限。
- **潜在风险**：
  - 大型仓库事件风暴：需在后端做节流/聚合；UI 仅渲染统计与少量示例。
  - 符号链接与循环：默认不跟随；可选项开启时需深度限制。
  - Windows/Unix 路径差异：统一使用 POSIX 风格在事件载荷内展示（库已提供 `to_posix`）。
  - crates 接口契约变化：若后续 `scanner.rs` API 调整，需同步胶水层。

## 接口契约（草案）
- **命令**（Rust，Tauri 2）：
  - `start_indexing(root: String, options: IndexOptions) -> Result<String, String>`
    - 返回 `task_id`（`uuid`）。内部 `spawn` 后台任务，持续 `emit` 事件。
  - `cancel_indexing(task_id: String) -> Result<(), String>`
- **IndexOptions（Rust/TS 对齐）**：
  - `respect_gitignore: bool`（默认 `true`）
  - `follow_symlinks: bool`（默认 `false`）
  - `extra_ignore_globs: Vec<String>`（默认空）
  - `include_globs: Vec<String>`（默认 `["**/*"]`）
  - `max_size_bytes: Option<u64>`（默认 `5MB`）
  - `absolute: bool`（默认 `false`；事件示例中仅回传相对路径与少量样本）
  - `sample_bytes: usize`（默认 `4096`）
- **事件载荷**：
  - `indexer://progress` → `{ task_id, scanned: u64, emitted: u64, binary: u64, current?: string, started_at_ms: u64, elapsed_ms: u64 }`
  - `indexer://done` → `{ task_id, total: u64, text: u64, binary: u64, skipped: u64, duration_ms: u64, sample: FileRecord[] }`
  - `indexer://error` → `{ task_id, message: string, path?: string }`
- **FileRecord（与 crates 对齐）**：`{ rel_path: string, abs_path?: string, size: number, mtime_ms: number, binary: boolean }`

# 任务列表
---

## Phase 1: 后端集成（Tauri × indexer）
- [x] Task 1: 在 `src-tauri/Cargo.toml` 引入 `crates/indexer` 本地依赖
- [x] Task 2: 定义 `AppState{ tasks, cancellations }` 与 `task_id` 生成器
- [x] Task 3: 实现 `start_indexing`（构造 `scanner::Config`，`spawn` 扫描，事件节流/聚合）
- [x] Task 4: 实现 `cancel_indexing`（设置取消标志，优雅停止）
- [x] Task 5: 在 `main.rs` 注册命令与初始化全局状态
- [x] Task 6: 配置 capabilities/权限（开启 `dialog.open` 与事件，限制前端 FS）
- [x] Task 7: `cargo check && cargo clippy -D warnings`

## Phase 2: 前端路由与页面
- [ ] Task 8: 新增 `react-router-dom`，以 `HashRouter` 包裹应用
- [ ] Task 9: 调整 `ui/App.tsx` 定义路由：`/chat`（默认）、`/indexer`
- [ ] Task 10: 修改 `ui/layout/Sidebar.tsx`，新增“项目解析”菜单项并使用 `useNavigate`
- [ ] Task 11: 新建 `ui/indexer/IndexerPage.tsx`（选择目录、开始/取消、进度条/日志）
- [ ] Task 12: 事件订阅与类型定义（`@tauri-apps/api/event`；TS 接口与 Rust 对齐）
- [ ] Task 13: `tsc --noEmit`、eslint 修复、前端运行验证

## Phase 3: 体验与可靠性
- [ ] Task 14: 进度事件节流与错误提示（AntD `Alert`）
- [ ] Task 15: 忽略策略 UI（默认开启 `.gitignore` + 常见目录；支持额外 glob）
- [ ] Task 16: 文档与 README 更新（使用说明、权限说明、SLO）

## Phase 4: 清理与交付
- [ ] Task 17: 移除临时代码/调试日志/脚本
- [ ] Task 18: 更新本文件“清理完成”标记与最终交付清单

---

## 变更记录
- 2025-09-12T00:00Z：创建任务拆分，确认 Tauri 2 集成方案与事件契约草案
